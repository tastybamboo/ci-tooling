#!/usr/bin/env bash
set -e

echo "Setting up git hooks with Lefthook..."

# Check if Lefthook is installed
if ! command -v lefthook &> /dev/null; then
  echo "Lefthook is not installed. Installing..."

  # Try to detect the best installation method
  if command -v brew &> /dev/null; then
    echo "Installing Lefthook via Homebrew..."
    brew install lefthook
  elif command -v gem &> /dev/null; then
    echo "Installing Lefthook via RubyGems..."
    gem install lefthook
  else
    echo "Error: Could not find a suitable package manager to install Lefthook."
    echo "Please install Lefthook manually:"
    echo "  - Homebrew: brew install lefthook"
    echo "  - RubyGems: gem install lefthook"
    echo "  - Or visit: https://github.com/evilmartians/lefthook"
    exit 1
  fi
fi

# Install the git hooks
echo "Installing git hooks..."
lefthook install

# Verify installation
if [[ -f .git/hooks/pre-commit ]]; then
  echo "✅ Git hooks installed successfully!"
  echo ""
  echo "Hooks are now active for:"
  echo "  - pre-commit: YAML validation, Dockerfile checks"
  echo "  - pre-push: Branch protection, full validation"
  echo ""
  echo "To skip hooks temporarily, use: git commit/push --no-verify"
else
  echo "❌ Failed to install git hooks"
  exit 1
fi